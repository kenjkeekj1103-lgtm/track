<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expedition Tracker - Legacy Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --color-gold: #c5a059; --color-crimson: #8b0000; }
        body { font-family: 'Playfair Display', serif; background: #0a0a0a; background-image: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%); color: #e2e2e2; min-height: 100vh; margin: 0; padding-bottom: 100px; }
        h1, h2, h3, .count-font, .nav-item, .rank-font, .title-font { font-family: 'Cinzel', serif; letter-spacing: 0.15em; }
        .expedition-card { background: rgba(18, 18, 18, 0.95); border: 1px solid rgba(197, 160, 89, 0.2); backdrop-filter: blur(20px); width: 100%; max-width: 360px; margin: 20px auto; padding: 30px 20px; box-shadow: 0 30px 60px rgba(0,0,0,0.8); }
        .btn-action { border: 1px solid var(--color-gold); color: var(--color-gold); background: transparent; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; cursor: pointer; }
        .btn-action:disabled { opacity: 0.15; cursor: not-allowed; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 10, 0.95); border-top: 1px solid rgba(197, 160, 89, 0.3); display: flex; justify-content: space-around; padding: 20px 0; z-index: 9999; }
        .nav-item { font-size: 11px; color: #555; cursor: pointer; transition: 0.4s; }
        .nav-item.active { color: var(--color-gold); text-shadow: 0 0 10px var(--color-gold); }
        .page { display: none; }
        .page.active { display: block; animation: pageIn 0.4s ease-out; }
        @keyframes pageIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .rank-item-container { border-bottom: 1px solid rgba(197, 160, 89, 0.1); padding: 15px 8px; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .title-tag { font-family: 'Cinzel'; font-size: 7px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.2em; opacity: 0.7; }
        .calendar-grid { display: grid !important; grid-template-columns: repeat(7, 1fr) !important; gap: 8px !important; }
        .day-box { aspect-ratio: 1/1.1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-family: 'Cinzel'; cursor: pointer; background: rgba(45, 45, 45, 0.6); -webkit-clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); transition: 0.3s; }
        .active-day { background: var(--color-gold) !important; color: #000 !important; font-weight: bold; }
        @keyframes flameWobble { 0%, 100% { transform: scale(1) rotate(-1deg); filter: brightness(1); } 50% { transform: scale(1.15) rotate(2deg); filter: brightness(1.3) drop-shadow(0 0 15px currentColor); } }
        .flame-svg { animation: flameWobble 2.5s infinite ease-in-out; }
        .particle { position: fixed; border-radius: 50%; pointer-events: none; opacity: 0; animation: dissipate 2.5s ease-out forwards; z-index: 9999; }
        @keyframes dissipate { 0% { opacity: 1; transform: translate(0, 0) scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); } }
    </style>
</head>
<body>

    <main id="logPage" class="page active">
        <div class="text-center mt-10 mb-6">
            <h1 class="text-2xl font-bold border-b border-stone-800 inline-block px-8 pb-2">THE LOG</h1>
            <p id="headerDate" class="text-[10px] text-stone-500 tracking-[0.3em] uppercase mt-4"></p>
        </div>

        <div class="expedition-card text-center relative">
            <p id="statusLabel" class="text-[9px] font-bold tracking-widest uppercase mb-6"></p>
            
            <div class="flex items-end justify-center gap-6 mb-10">
                <div class="flex flex-col items-center mb-2">
                    <span class="text-[7px] text-stone-600 uppercase tracking-[0.2em] mb-1 font-bold">Monthly Total</span>
                    <div id="monthlyTotalDisplay" class="count-font text-3xl text-stone-500 transition-colors duration-500">0</div>
                </div>

                <div id="mainCountDisplay" class="count-font text-8xl font-light text-stone-100">0</div>
                
                <div id="streakContainer" class="flex flex-col items-center mb-2" style="display: none;">
                    <span id="streakNumber" class="text-[14px] font-bold mb-1 count-font">0</span>
                    <svg class="flame-svg w-10 h-10" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.94,2C10,2,8.47,3.12,7.41,4.72c-1.12,1.69-1.22,3.7-0.78,5.5c0.11,0.46,0.3,0.92,0.56,1.35c-0.12-0.57-0.15-1.16-0.09-1.74 c0.07-0.67,0.25-1.33,0.56-1.93C8.16,6.91,9.08,6,10,6c0.5,0,1,0.21,1.38,0.58C11.14,6.23,10.74,6,10.28,6 c-0.58,0-1.11,0.34-1.35,0.87C8.75,7.26,8.81,7.69,9.11,8c0.61,0.61,1.62,1,2.5,1c1.2,0,2.15,0.45,2.77,1.21 c0.61,0.76,0.85,1.79,0.58,2.79c-0.34,1.24-1.5,2-2.8,2c-0.34,0-0.69-0.05-1.04-0.16c0.69,0.34,1.48,0.53,2.28,0.53 c2.6,0,4.71-1.92,5-4.4c0.14-1.21-0.11-2.42-0.72-3.48c-0.61-1.05-1.54-1.87-2.65-2.31C13.88,4.74,13.2,4.36,12.5,4.12 C12.31,4.04,12.12,4,11.94,2z M12,22c4.42,0,8-3.58,8-8c0-1.42-0.37-2.75-1.02-3.89C18.17,8.96,16.52,8,14.65,8 c-0.66,0-1.27,0.18-1.8,0.5c0.88,0.21,1.57,0.81,1.96,1.6c0.39,0.79,0.43,1.71,0.1,2.55c-0.3,0.78-0.96,1.33-1.76,1.5 c-0.15,0.03-0.3,0.05-0.45,0.05c-1.1,0-2-0.9-2-2c0-0.55-0.45-1-1-1s-1,0.45-1,1c0,1.94,1.06,3.63,2.65,4.55 C10.51,16.91,9,18.28,9,20C9,21.1,9.9,22,12,22z"></path>
                    </svg>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <button id="execBtn" class="btn-action py-4 text-xs font-bold">Execute Action</button>
                <button id="undoBtn" class="text-[9px] text-stone-600 uppercase tracking-widest py-2">Undo Action</button>
            </div>
        </div>

        <div class="expedition-card">
            <div class="flex justify-between items-center mb-6">
                <button id="prevMonth" class="text-stone-500 p-2 text-xl">‹</button>
                <h2 id="monthLabel" class="text-[10px] font-bold tracking-[0.2em] text-stone-300 uppercase"></h2>
                <button id="nextMonth" class="text-stone-500 p-2 text-xl">›</button>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
    </main>

    <main id="pantheonPage" class="page">
        <div class="text-center mt-10 mb-6">
            <h1 class="text-2xl font-bold border-b border-stone-800 inline-block px-8 pb-2 uppercase">Pantheon</h1>
            <p id="pantheonMonthLabel" class="text-[10px] text-stone-500 tracking-[0.3em] uppercase mt-4"></p>
        </div>
        <div class="expedition-card">
            <div id="leaderboardUI" class="space-y-2">
                <p class="text-center text-[10px] text-stone-600 italic">Reading the Monolith...</p>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div id="navLog" class="nav-item active" onclick="window.switchPage('logPage')">Log</div>
        <div id="navPantheon" class="nav-item" onclick="window.switchPage('pantheonPage')">Pantheon</div>
    </nav>

    <script>
        // --- 填入你的精確密鑰 ---
        const SB_URL = 'https://gplbgoevwtgvwxjhbzdy.supabase.co';
        const SB_KEY = 'sb_publishable_cIdXEi7cwaKb5gtSFTokdA_McBkYwXb';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        window.onload = function() {
            let historyData = JSON.parse(localStorage.getItem('exp_history_v3')) || {};
            let viewDate = new Date();
            let selectedDs = getDs(new Date());
            let myUsername = localStorage.getItem('exp_user');

            function getDs(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

            function getMonthlyTotal() {
                const now = new Date();
                const curM = now.getMonth(); const curY = now.getFullYear();
                let total = 0;
                for (let ds in historyData) {
                    const d = new Date(ds.replace(/-/g, '/'));
                    if (d.getMonth() === curM && d.getFullYear() === curY) total += historyData[ds];
                }
                return total;
            }

            function getTitle(count) {
                if (count >= 100) return "遠征王者 (The GOAT Voyager)";
                if (count >= 60)  return "傳奇先鋒 (Legendary Vanguard)";
                if (count >= 30)  return "荒野守望者 (Wilderness Sentinel)";
                if (count >= 10)  return "資深斥侯 (Veteran Scout)";
                return "迷霧新兵 (Mist Recruit)";
            }

            async function initUser() {
                if (!myUsername) {
                    myUsername = prompt("Enter your Codename for The Pantheon:");
                    if (myUsername) { localStorage.setItem('exp_user', myUsername); await syncCloud(); }
                }
                updateUI(); fetchPantheon();
            }

            async function syncCloud() {
                if (!myUsername || SB_URL.includes('在此填入')) return;
                await supabaseClient.from('leaderboard').upsert({ username: myUsername, essence_count: getMonthlyTotal(), last_action_at: new Date().toISOString() }, { onConflict: 'username' });
            }

            async function fetchPantheon() {
                if (SB_URL.includes('在此填入')) return;
                const now = new Date();
                document.getElementById('pantheonMonthLabel').innerText = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(now).toUpperCase() + " RANKINGS";
                const { data } = await supabaseClient.from('leaderboard').select('*').order('essence_count', { ascending: false }).limit(10);
                if (data) {
                    const ui = document.getElementById('leaderboardUI');
                    const rom = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
                    ui.innerHTML = data.map((user, i) => {
                        const title = getTitle(user.essence_count);
                        const isMe = user.username === myUsername;
                        const gold = i < 3;
                        return `
                            <div class="rank-item-container ${isMe ? 'bg-gold-500/5 border-l-2 border-gold-500' : ''}">
                                <span class="title-tag ${gold ? 'text-gold-500' : 'text-stone-600'}">${title}</span>
                                <div class="flex justify-between w-full items-center">
                                    <span class="rank-font text-xs ${gold ? 'text-gold-500' : 'text-stone-400'}">${rom[i]}. ${user.username}</span>
                                    <span class="count-font text-sm ${gold ? 'text-gold-500' : 'text-stone-300'}">${user.essence_count}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            function updateUI() {
                const count = historyData[selectedDs] || 0;
                const mTotal = getMonthlyTotal();
                const target = new Date(selectedDs.replace(/-/g, '/'));
                const todayDs = getDs(new Date());
                const today = new Date(todayDs.replace(/-/g, '/'));
                
                document.getElementById('mainCountDisplay').innerText = count;
                document.getElementById('headerDate').innerText = target.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                const mDisplay = document.getElementById('monthlyTotalDisplay');
                mDisplay.innerText = mTotal;

                // 彩蛋邏輯：Miami Heat Red (6) & Lakers Purple (23)
                if (mTotal === 6) mDisplay.style.color = '#98002E';
                else if (mTotal === 23) mDisplay.style.color = '#552583';
                else mDisplay.style.color = ''; // 恢復預設石灰色

                const label = document.getElementById('statusLabel');
                const streakContainer = document.getElementById('streakContainer');
                if (target > today) {
                    label.innerText = "Locked Destiny"; label.style.color = "#444";
                    document.getElementById('execBtn').disabled = true; streakContainer.style.display = 'none';
                } else {
                    label.innerText = target < today ? "Historical Record" : "Current Manifestation";
                    label.style.color = target < today ? "var(--color-gold)" : "#fff";
                    document.getElementById('execBtn').disabled = false;
                    const streak = calculateStreak();
                    if (streak > 0) {
                        streakContainer.style.display = 'flex';
                        document.getElementById('streakNumber').innerText = streak;
                        const color = streak >= 10 ? '#e11d48' : (streak >= 5 ? '#a855f7' : '#4a1d96');
                        document.querySelector('.flame-svg').style.color = color;
                        document.getElementById('streakNumber').style.color = color;
                    } else streakContainer.style.display = 'none';
                }
                renderCalendar();
            }

            function calculateStreak() {
                let streak = 0; let checkDate = new Date();
                if (!historyData[getDs(checkDate)] || historyData[getDs(checkDate)] === 0) checkDate.setDate(checkDate.getDate() - 1);
                while (true) {
                    let ds = getDs(checkDate);
                    if (historyData[ds] && historyData[ds] > 0) { streak++; checkDate.setDate(checkDate.getDate() - 1); } 
                    else break;
                }
                return streak;
            }

            window.switchPage = function(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                if (pageId === 'logPage') { document.getElementById('navLog').classList.add('active'); updateUI(); }
                else { document.getElementById('navPantheon').classList.add('active'); fetchPantheon(); }
            };

            function renderCalendar() {
                const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
                const y = viewDate.getFullYear(), m = viewDate.getMonth();
                document.getElementById('monthLabel').innerText = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(viewDate);
                const first = new Date(y, m, 1).getDay(); const total = new Date(y, m + 1, 0).getDate();
                for (let i = 0; i < first; i++) grid.appendChild(document.createElement('div'));
                for (let d = 1; d <= total; d++) {
                    const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const c = historyData[ds] || 0;
                    const isF = new Date(ds.replace(/-/g, '/')) > new Date(getDs(new Date()).replace(/-/g, '/'));
                    const box = document.createElement('div'); box.className = `day-box ${ds === selectedDs ? 'active-day' : ''}`;
                    box.innerHTML = `<span>${d}</span>`;
                    if (!isF) {
                        if (c > 5) box.style.backgroundColor = 'rgba(139, 0, 0, 0.7)';
                        else if (c > 2) box.style.backgroundColor = 'rgba(197, 160, 89, 0.5)';
                        else if (c > 0) box.style.backgroundColor = 'rgba(46, 125, 50, 0.5)';
                    } else box.style.opacity = '0.1';
                    box.onclick = () => { selectedDs = ds; updateUI(); };
                    grid.appendChild(box);
                }
            }

            document.getElementById('execBtn').onclick = async () => {
                historyData[selectedDs] = (historyData[selectedDs] || 0) + 1;
                localStorage.setItem('exp_history_v3', JSON.stringify(historyData));
                const rect = document.getElementById('mainCountDisplay').getBoundingClientRect();
                for (let i = 0; i < 70; i++) spawn(rect);
                updateUI(); await syncCloud();
            };

            document.getElementById('undoBtn').onclick = async () => {
                if (historyData[selectedDs] > 0) { historyData[selectedDs]--; localStorage.setItem('exp_history_v3', JSON.stringify(historyData)); updateUI(); await syncCloud(); }
            };

            function spawn(r) {
                const p = document.createElement('div'); p.className = 'particle'; document.body.appendChild(p);
                p.style.left = (r.left + Math.random() * r.width) + 'px'; p.style.top = (r.top + Math.random() * r.height) + 'px';
                p.style.background = ['#c5a059', '#fff', '#8b0000'][Math.floor(Math.random() * 3)];
                p.style.width = p.style.height = (Math.random() * 4 + 1) + 'px';
                p.style.setProperty('--tx', (Math.random() * 300 + 200) + 'px');
                p.style.setProperty('--ty', ((Math.random() - 0.5) * 150 - 50) + 'px');
                setTimeout(() => p.remove(), 2500);
            }

            document.getElementById('prevMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); renderCalendar(); };

            initUser();
        };
    </script>
</body>
</html>